
# Создание конфигурационных файлов для фаззинг-тестов

Конфигурационный файл — это загружаемый в BondiFuzz вспомогательный файл, в котором указываются дополнительные опции, необходимые для правильной работы фаззинг-теста.

## Содержимое конфигурационного файла фаззинг-теста на основе AFL

Пример конфигурационного файла фаззинг-теста на основе AFL:

```json
{
    "target": {
        "path": "url-fuzz-target",
    },
    "env": {
        "MY_ENV": "val"
    },
    "options": {
        "afl": {
            "min_length": 50,
        }
    }
}
```

`target` — путь к бинарному файлу фаззинг-теста.

Возможные опции:

`mode` — режимы работы AFL. В BondiFuzz на данный момент поддерживается только режим Normal.

`schedule` — алгоритмы оценки входных данных, чтобы понять что лучше дальше мутировать чтобы быстрее получить входные данные, увеличивающие покрытие. [Более подробно](https://aflplus.plus/docs/power_schedules/).

`dict` — словарь, значения из которого будут использоваться иногда вместо случайной мутации.

`file_extension` — если бинарный файл фаззинг-теста принимает на вход в качестве аргумента путь к файлу, то можно указать какое расширение должно быть у этого файла.

`min_length` — минимальная длина входных данных.

`max_length` — максимальная длина входных данных.

`queue_selection` — все входные данные в AFL находятся в очереди, опция дает возможность выбирать либо поочередно либо согласно весам.

`python_module` — AFL позволяет написать модуль на языке Python, затем использовать его как мутатор. [Более подробно](https://aflplus.plus/docs/custom_mutators/).

`custom_mutator_library` — кастомная библиотека, которая будет использоваться как мутатор. [Более подробно](https://aflplus.plus/docs/custom_mutators/).

`custom_mutator_only` — все вызовы на мутации будут обрабатываться указанными выше библиотекой/Python-модулем.

`hang_timeout` — граница после которой входные данные считаются hang'ом.

`map_size` — размер "массива" хранящего информацию по покрытию фаззинг-тестом кода.

## Предзагрузка библиотек для AFL

`AFL_PRELOAD` — способ подгрузить библиотеку к запускаемому файлу. `AFL_PRELOAD` необходим когда фаззинг-тест использует внешние зависимости, для загрузки библиотек по указанному в нем пути. Пример:

```bash
AFL_PRELOAD=/path/to/libcompcov.so
```

## Содержимое конфигурационного файла LibFuzzer-а

Пример конфигурационного файла для LibFuzzer-а:

```json
{
    "target" : {
        "path": "my_binary",
    }
    "env": {
        "MY_ENV": "val"
    },
    "options": {
        "libfuzzer": {
            "max_len": "512"
        },
    }
}
```

`target` — путь к бинарному файлу фаззинг-теса.

Возможные опции:

`max_len` — максимальная длинна входных данных.

`dict` — файл словаря, который используется в качестве сидов.

`prefer_small` — если значение равно 1, выбор меньших входных данных. 

`timeout` — временная задержка, значение указывается в секундах.

`report_slow_units` — пороговое значение, при достижении которого входные данные будут интерпретироваться как не валидные.

`only_ascii` — если значение равно 1, входные данные только в формате ASCII.

`detect_leaks` — если значение равно 1, предпринимается попытка определения утечек памяти.

`len_control` — указывает скорость, с которой увеличивается предел длины.

`mutate_depth` — количество мутаций для входных данных.

Больше опций можно найти по [ссылке](https://llvm.org/docs/LibFuzzer.html#options).

## Предзагрузка библиотек для LibFuzzer-а

Прелоады для добавления библиотек:

`LD_PRELOAD` — способ подгрузить библиотеку к запускаемому файлу. `LD_PRELOAD` необходим когда фаззинг-тест использует внешние зависимости, для загрузки библиотек по указанному в нем пути. Пример:

```
LD_PRELOAD": "./libs/libarchive.so.13 ./libs/libicudata.so.60 ./libs/libicuuc.so.60 ./libs/liblzo2.so.2 ./libs/libxml2.so.2
```

Для того чтобы не указывать все библиотеки можно использовать `LD_LIBRARY_PATH`, указав в качестве значения путь до директории, где лежат все необходимые для файла библиотеки. Пример:

```
LD_LIBRARY_PATH": "./libs
```
